<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for CSV Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0fdf4; }
        .stat-card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .chart-container { position: relative; height: 400px; width: 100%; }
        .table-container { overflow-x: auto; background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #f0fdf4; color: #065f46; font-weight: 600; text-align: left; padding: 1rem; border-bottom: 2px solid #d1fae5; }
        td { padding: 1rem; border-bottom: 1px solid #f0fdf4; color: #1e293b; }
        tr:hover { background-color: #f9fefc; }
        .loading-spinner { border: 4px solid #ecfdf5; border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Ranking Highlight Styles */
        .rank-1 { background-color: #fefce8; border: 1px solid #fde047; }
        .rank-2 { background-color: #f8fafc; border: 1px solid #e2e8f0; }
        .rank-3 { background-color: #fff7ed; border: 1px solid #fdba74; }
        .badge-1 { background-color: #eab308; color: white; }
        .badge-2 { background-color: #94a3b8; color: white; }
        .badge-3 { background-color: #d97706; color: white; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-emerald-900">ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-emerald-700 mt-2">êµ¬ê¸€ ì‹œíŠ¸ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë¶€ë™ì‚° ì‹œì¥ í˜„í™©</p>
            </div>
            <div class="flex flex-col items-end gap-2">
                <div class="flex items-center gap-2">
                    <label for="dongFilter" class="text-sm font-bold text-emerald-800">ğŸ“ ë™ë„¤ ì„ íƒ:</label>
                    <select id="dongFilter" class="p-2 rounded-lg border border-emerald-200 bg-white text-emerald-800 focus:ring-2 focus:ring-emerald-500 outline-none min-w-[150px]">
                        <option value="All">ì „ì²´ ë³´ê¸°</option>
                    </select>
                </div>
                <div id="lastUpdate" class="text-sm text-emerald-600/60">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
        </header>

        <!-- Loading Overlay -->
        <div id="loader" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-emerald-700 font-medium">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card border-l-4 border-emerald-500">
                <p class="text-sm text-emerald-600 font-medium mb-1">ğŸ  ì „ì²´ ê±°ë˜ ê±´ìˆ˜</p>
                <h3 id="totalCount" class="text-2xl font-bold text-emerald-700">- ê±´</h3>
            </div>
            <div class="stat-card border-l-4 border-teal-500">
                <p class="text-sm text-teal-600 font-medium mb-1">ğŸ’° í‰ê·  ê±°ë˜ê°€</p>
                <h3 id="avgPrice" class="text-2xl font-bold text-teal-700">- ë§Œì›</h3>
            </div>
            <div class="stat-card border-l-4 border-green-600">
                <p class="text-sm text-green-600 font-medium mb-1">ğŸ“ˆ ìµœê³  ê±°ë˜ê°€</p>
                <h3 id="maxPrice" class="text-2xl font-bold text-green-800">- ë§Œì›</h3>
            </div>
            <div class="stat-card border-l-4 border-lime-500">
                <p class="text-sm text-lime-600 font-medium mb-1">ğŸ“‰ ìµœì € ê±°ë˜ê°€</p>
                <h3 id="minPrice" class="text-2xl font-bold text-lime-700">- ë§Œì›</h3>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Chart Section -->
            <div class="lg:col-span-2 stat-card">
                <h3 class="text-lg font-bold text-emerald-900 mb-6">ì›”ë³„ í‰ê·  ê±°ë˜ê°€ê²© ì¶”ì´</h3>
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- Distribution Info -->
            <div class="stat-card">
                <h3 class="text-lg font-bold text-emerald-900 mb-6">ë‹¨ì§€ë³„ ê±°ë˜ ë¹„ì¤‘</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="aptDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ranking & List Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Ranking Section -->
            <div class="lg:col-span-1 stat-card">
                <h3 class="text-lg font-bold text-emerald-900 mb-6">ìš°ë¦¬ ë™ë„¤ ë¹„ì‹¼ ì•„íŒŒíŠ¸ TOP 5</h3>
                <div id="rankingContainer" class="space-y-3">
                    <!-- Ranking items will be injected here -->
                </div>
            </div>

            <!-- Table Section -->
            <div class="lg:col-span-2 stat-card">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-emerald-900">ìµœê·¼ ì‹¤ê±°ë˜ ëª©ë¡</h3>
                    <span class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full uppercase font-bold">Live Data</span>
                </div>
                <div class="table-container">
                    <table id="dataList">
                        <thead>
                            <tr>
                                <th>ê±°ë˜ì¼ì</th>
                                <th>ì•„íŒŒíŠ¸ëª…</th>
                                <th>ë²•ì •ë™</th>
                                <th>ë©´ì (ã¡)</th>
                                <th>ì¸µ</th>
                                <th>ê±°ë˜ê¸ˆì•¡(ë§Œì›)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTVksWeVXGj0W_9v5I_HwN7nyzZ11TfXXq5UUIucR3gwwdNfEaH2ajaHTwTb6x7KzvDtiZZf7gYEFPe/pub?gid=997004150&single=true&output=csv';
        let rawData = [];
        let priceChartInstance = null;
        let aptChartInstance = null;

        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                const csvData = await response.text();
                
                Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        rawData = results.data;
                        initFilter(rawData);
                        updateDashboard('All');
                        document.getElementById('loader').style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loader').innerHTML = '<p class="text-red-500 font-bold">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        function initFilter(data) {
            const dongSet = new Set();
            data.forEach(item => {
                if (item['ë²•ì •ë™']) dongSet.add(item['ë²•ì •ë™'].trim());
            });

            const sortedDongs = Array.from(dongSet).sort();
            const filterEl = document.getElementById('dongFilter');
            
            sortedDongs.forEach(dong => {
                const option = document.createElement('option');
                option.value = dong;
                option.innerText = dong;
                filterEl.appendChild(option);
            });

            filterEl.addEventListener('change', (e) => {
                updateDashboard(e.target.value);
            });
        }

        function cleanNumber(val) {
            if (!val) return 0;
            return parseFloat(val.toString().replace(/,/g, ''));
        }

        function updateDashboard(filterValue) {
            const filteredData = filterValue === 'All' 
                ? rawData 
                : rawData.filter(item => item['ë²•ì •ë™'] && item['ë²•ì •ë™'].trim() === filterValue);

            if (!filteredData || filteredData.length === 0) return;

            // 1. Summary Stats
            const prices = filteredData.map(item => cleanNumber(item['ê±°ë˜ê¸ˆì•¡(ë§Œì›)']));
            const totalCount = filteredData.length;
            const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / totalCount);
            const maxPrice = Math.max(...prices);
            const minPrice = Math.min(...prices);

            document.getElementById('totalCount').innerText = `${totalCount.toLocaleString()} ê±´`;
            document.getElementById('avgPrice').innerText = `${avgPrice.toLocaleString()} ë§Œì›`;
            document.getElementById('maxPrice').innerText = `${maxPrice.toLocaleString()} ë§Œì›`;
            document.getElementById('minPrice').innerText = `${minPrice.toLocaleString()} ë§Œì›`;
            document.getElementById('lastUpdate').innerText = `ìµœì¢… ì—…ë°ì´íŠ¸: ${new Date().toLocaleString()}`;

            // 2. Charts
            updateCharts(filteredData);

            // 3. Ranking TOP 5
            updateRanking(filteredData);

            // 4. Populate Table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            filteredData.slice().reverse().slice(0, 30).forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-sm">${item['ê±°ë˜ì¼ì']}</td>
                    <td class="font-bold text-emerald-700 text-sm">${item['ì•„íŒŒíŠ¸ëª…']}</td>
                    <td class="text-sm">${item['ë²•ì •ë™']}</td>
                    <td class="text-sm">${item['ì „ìš©ë©´ì (ã¡)']}</td>
                    <td class="text-sm">${item['ì¸µ']}ì¸µ</td>
                    <td class="text-right font-semibold text-emerald-900">${parseInt(item['ê±°ë˜ê¸ˆì•¡(ë§Œì›)']).toLocaleString()}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function updateRanking(data) {
            const rankingContainer = document.getElementById('rankingContainer');
            rankingContainer.innerHTML = '';

            // Sort by price descending
            const sorted = [...data].sort((a, b) => cleanNumber(b['ê±°ë˜ê¸ˆì•¡(ë§Œì›)']) - cleanNumber(a['ê±°ë˜ê¸ˆì•¡(ë§Œì›)']));
            const top5 = sorted.slice(0, 5);

            top5.forEach((item, index) => {
                const rank = index + 1;
                const div = document.createElement('div');
                let rankClass = '';
                let badgeClass = 'bg-emerald-100 text-emerald-700';
                let icon = '';

                if (rank === 1) { rankClass = 'rank-1'; badgeClass = 'badge-1'; icon = 'ğŸ¥‡'; }
                else if (rank === 2) { rankClass = 'rank-2'; badgeClass = 'badge-2'; icon = 'ğŸ¥ˆ'; }
                else if (rank === 3) { rankClass = 'rank-3'; badgeClass = 'badge-3'; icon = 'ğŸ¥‰'; }

                div.className = `p-4 rounded-xl flex items-center justify-between ${rankClass} border border-transparent transition-all hover:scale-[1.02]`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${badgeClass}">
                            ${icon ? icon : rank}
                        </div>
                        <div>
                            <p class="font-bold text-slate-800 leading-tight">${item['ì•„íŒŒíŠ¸ëª…']}</p>
                            <p class="text-xs text-slate-500 mt-1">${item['ì „ìš©ë©´ì (ã¡)']}ã¡ / ${item['ì¸µ']}ì¸µ</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-emerald-900">${parseInt(item['ê±°ë˜ê¸ˆì•¡(ë§Œì›)']).toLocaleString()}</p>
                        <p class="text-[10px] text-slate-400 uppercase font-bold">ë§Œì›</p>
                    </div>
                `;
                rankingContainer.appendChild(div);
            });
        }

        function updateCharts(filteredData) {
            const monthlyData = {};
            filteredData.forEach(item => {
                let dateStr = item['ê±°ë˜ì¼ì'].toString();
                let month = dateStr.length >= 6 ? `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}` : dateStr;
                if (!monthlyData[month]) monthlyData[month] = { total: 0, count: 0 };
                monthlyData[month].total += cleanNumber(item['ê±°ë˜ê¸ˆì•¡(ë§Œì›)']);
                monthlyData[month].count += 1;
            });
            const labels = Object.keys(monthlyData).sort();
            const avgPrices = labels.map(l => Math.round(monthlyData[l].total / monthlyData[l].count));
            renderPriceChart(labels, avgPrices);

            const aptCounts = {};
            filteredData.forEach(item => {
                const apt = item['ì•„íŒŒíŠ¸ëª…'];
                aptCounts[apt] = (aptCounts[apt] || 0) + 1;
            });
            const topApts = Object.entries(aptCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            renderAptChart(topApts.map(a => a[0]), topApts.map(a => a[1]));
        }

        function renderPriceChart(labels, data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (priceChartInstance) priceChartInstance.destroy();
            priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í‰ê·  ê±°ë˜ê¸ˆì•¡ (ë§Œì›)',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#059669',
                        pointBorderColor: '#fff',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { callback: v => v.toLocaleString() + 'ë§Œ', color: '#065f46' }, grid: { color: '#f0fdf4' } },
                        x: { ticks: { color: '#065f46' }, grid: { display: false } }
                    }
                }
            });
        }

        function renderAptChart(labels, data) {
            const ctx = document.getElementById('aptDistributionChart').getContext('2d');
            if (aptChartInstance) aptChartInstance.destroy();
            aptChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#059669', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#065f46', font: { size: 10 } } } },
                    cutout: '65%'
                }
            });
        }

        window.onload = fetchData;
    </script>
</body>
</html>
