<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for CSV Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0fdf4; } /* ë°°ê²½ì„ ì—°í•œ ì´ˆë¡ë¹›ìœ¼ë¡œ ë³€ê²½ */
        .stat-card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .chart-container { position: relative; height: 400px; width: 100%; }
        .table-container { overflow-x: auto; background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #f0fdf4; color: #065f46; font-weight: 600; text-align: left; padding: 1rem; border-bottom: 2px solid #d1fae5; }
        td { padding: 1rem; border-bottom: 1px solid #f0fdf4; color: #1e293b; }
        tr:hover { background-color: #f9fefc; }
        .loading-spinner { border: 4px solid #ecfdf5; border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-emerald-900">ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-emerald-700 mt-2">êµ¬ê¸€ ì‹œíŠ¸ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë¶€ë™ì‚° ì‹œì¥ í˜„í™©</p>
            </div>
            <div id="lastUpdate" class="text-sm text-emerald-600/60">ë°ì´í„° ë¡œë”© ì¤‘...</div>
        </header>

        <!-- Loading Overlay -->
        <div id="loader" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-emerald-700 font-medium">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card border-l-4 border-emerald-500">
                <p class="text-sm text-emerald-600 font-medium mb-1">ğŸ  ì „ì²´ ê±°ë˜ ê±´ìˆ˜</p>
                <h3 id="totalCount" class="text-2xl font-bold text-emerald-700">- ê±´</h3>
            </div>
            <div class="stat-card border-l-4 border-teal-500">
                <p class="text-sm text-teal-600 font-medium mb-1">ğŸ’° í‰ê·  ê±°ë˜ê°€</p>
                <h3 id="avgPrice" class="text-2xl font-bold text-teal-700">- ë§Œì›</h3>
            </div>
            <div class="stat-card border-l-4 border-green-600">
                <p class="text-sm text-green-600 font-medium mb-1">ğŸ“ˆ ìµœê³  ê±°ë˜ê°€</p>
                <h3 id="maxPrice" class="text-2xl font-bold text-green-800">- ë§Œì›</h3>
            </div>
            <div class="stat-card border-l-4 border-lime-500">
                <p class="text-sm text-lime-600 font-medium mb-1">ğŸ“‰ ìµœì € ê±°ë˜ê°€</p>
                <h3 id="minPrice" class="text-2xl font-bold text-lime-700">- ë§Œì›</h3>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Chart Section -->
            <div class="lg:col-span-2 stat-card">
                <h3 class="text-lg font-bold text-emerald-900 mb-6">ì›”ë³„ í‰ê·  ê±°ë˜ê°€ê²© ì¶”ì´</h3>
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- Distribution Info -->
            <div class="stat-card">
                <h3 class="text-lg font-bold text-emerald-900 mb-6">ë‹¨ì§€ë³„ ê±°ë˜ ë¹„ì¤‘</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="aptDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="stat-card mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-emerald-900">ìµœê·¼ ì‹¤ê±°ë˜ ëª©ë¡</h3>
                <span class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full uppercase font-bold">Live Data</span>
            </div>
            <div class="table-container">
                <table id="dataList">
                    <thead>
                        <tr>
                            <th>ê±°ë˜ì¼ì</th>
                            <th>ì•„íŒŒíŠ¸ëª…</th>
                            <th>ë²•ì •ë™</th>
                            <th>ì „ìš©ë©´ì (ã¡)</th>
                            <th>ì¸µ</th>
                            <th>ê±°ë˜ê¸ˆì•¡(ë§Œì›)</th>
                            <th>ê±´ì¶•ë…„ë„</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTVksWeVXGj0W_9v5I_HwN7nyzZ11TfXXq5UUIucR3gwwdNfEaH2ajaHTwTb6x7KzvDtiZZf7gYEFPe/pub?gid=997004150&single=true&output=csv';

        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                const csvData = await response.text();
                
                Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processData(results.data);
                        document.getElementById('loader').style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loader').innerHTML = '<p class="text-red-500 font-bold">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        function cleanNumber(val) {
            if (!val) return 0;
            return parseFloat(val.toString().replace(/,/g, ''));
        }

        function processData(data) {
            if (!data || data.length === 0) return;

            const prices = data.map(item => cleanNumber(item['ê±°ë˜ê¸ˆì•¡(ë§Œì›)']));
            const totalCount = data.length;
            const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / totalCount);
            const maxPrice = Math.max(...prices);
            const minPrice = Math.min(...prices);

            document.getElementById('totalCount').innerText = `${totalCount.toLocaleString()} ê±´`;
            document.getElementById('avgPrice').innerText = `${avgPrice.toLocaleString()} ë§Œì›`;
            document.getElementById('maxPrice').innerText = `${maxPrice.toLocaleString()} ë§Œì›`;
            document.getElementById('minPrice').innerText = `${minPrice.toLocaleString()} ë§Œì›`;
            document.getElementById('lastUpdate').innerText = `ìµœì¢… ì—…ë°ì´íŠ¸: ${new Date().toLocaleString()}`;

            const monthlyData = {};
            data.forEach(item => {
                let dateStr = item['ê±°ë˜ì¼ì'].toString();
                let month = dateStr.length >= 6 ? `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}` : dateStr;
                if (!monthlyData[month]) {
                    monthlyData[month] = { total: 0, count: 0 };
                }
                monthlyData[month].total += cleanNumber(item['ê±°ë˜ê¸ˆì•¡(ë§Œì›)']);
                monthlyData[month].count += 1;
            });

            const labels = Object.keys(monthlyData).sort();
            const avgPrices = labels.map(l => Math.round(monthlyData[l].total / monthlyData[l].count));

            renderPriceChart(labels, avgPrices);

            const aptCounts = {};
            data.forEach(item => {
                const apt = item['ì•„íŒŒíŠ¸ëª…'];
                aptCounts[apt] = (aptCounts[apt] || 0) + 1;
            });
            const topApts = Object.entries(aptCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            renderAptChart(topApts.map(a => a[0]), topApts.map(a => a[1]));

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            data.slice().reverse().forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-medium">${item['ê±°ë˜ì¼ì']}</td>
                    <td class="font-bold text-emerald-700">${item['ì•„íŒŒíŠ¸ëª…']}</td>
                    <td>${item['ë²•ì •ë™']}</td>
                    <td>${item['ì „ìš©ë©´ì (ã¡)']}</td>
                    <td>${item['ì¸µ']}ì¸µ</td>
                    <td class="text-right font-semibold text-emerald-900">${parseInt(item['ê±°ë˜ê¸ˆì•¡(ë§Œì›)']).toLocaleString()}</td>
                    <td class="text-slate-500">${item['ê±´ì¶•ë…„ë„']}ë…„</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function renderPriceChart(labels, data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í‰ê·  ê±°ë˜ê¸ˆì•¡ (ë§Œì›)',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#059669',
                        pointBorderColor: '#fff',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#f0fdf4' },
                            ticks: { callback: value => value.toLocaleString() + 'ë§Œ', color: '#065f46' }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#065f46' }
                        }
                    }
                }
            });
        }

        function renderAptChart(labels, data) {
            const ctx = document.getElementById('aptDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#059669', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0'
                        ],
                        hoverOffset: 10,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { boxWidth: 10, padding: 15, color: '#065f46', font: { size: 11 } } 
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        window.onload = fetchData;
    </script>
</body>
</html>
